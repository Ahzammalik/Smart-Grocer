<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const listContainer = document.getElementById('grocery-list-container');
        const groceryItemsView = document.getElementById('grocery-items-view'); // IMPORTANT: New reference
        const emptyStateMessage = document.getElementById('empty-state-message');
        const totalAmountEl = document.getElementById('total-amount');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemTemplate = document.getElementById('grocery-item-template');
        const currencySelector = document.getElementById('currency-selector');
        const checkoutBtn = document.getElementById('checkout-btn');
        const viewHistoryBtn = document.getElementById('view-history-btn');
        const historySection = document.getElementById('history-section');
        const historyListEl = document.getElementById('history-list');
        const emptyHistoryMessage = document.getElementById('empty-history-message');
        const historyItemTemplate = document.getElementById('history-item-template');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        // Modal Elements
        const modal = document.getElementById('add-item-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const itemNameInput = document.getElementById('item-name-input');
        const itemPriceInput = document.getElementById('item-price-input'); // Corrected typo here (was document = document)

        // --- App State ---
        let groceryList = [];
        let shoppingHistory = [];
        let currentCurrency = localStorage.getItem('smartGrocerCurrency') || 'USD';

        // --- Currency Configuration (Add/Remove as needed) ---
        const currencySymbols = {
            'USD': '$',
            'EUR': '€',
            'GBP': '£',
            'PKR': '₨',
            'JPY': '¥',
        };

        // --- Core Functions ---

        const saveState = () => {
            localStorage.setItem('smartGrocerList', JSON.stringify(groceryList));
            localStorage.setItem('smartGrocerHistory', JSON.stringify(shoppingHistory));
            localStorage.setItem('smartGrocerCurrency', currentCurrency);
        };

        const loadState = () => {
            const savedList = localStorage.getItem('smartGrocerList');
            if (savedList) {
                groceryList = JSON.parse(savedList);
            }
            const savedHistory = localStorage.getItem('smartGrocerHistory');
            if (savedHistory) {
                shoppingHistory = JSON.parse(savedHistory);
            }
            currencySelector.value = currentCurrency; // Set initial currency in dropdown
            
            // Initial UI state: always show cart view and hide history
            toggleHistoryView(false); // Force switch to cart view at load
            renderHistory(); // Render history items once (they are hidden by toggleHistoryView)
        };

        const formatCurrency = (amount) => {
            const symbol = currencySymbols[currentCurrency] || '$'; // Default to $ if not found
            return `${symbol}${amount.toFixed(2)}`;
        };

        const calculateTotal = () => {
            const total = groceryList.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalAmountEl.textContent = formatCurrency(total);
        };

        const render = () => {
            // Clear existing grocery items within their specific view container
            groceryItemsView.innerHTML = ''; 

            if (groceryList.length === 0) {
                groceryItemsView.appendChild(emptyStateMessage);
                emptyStateMessage.style.display = 'block';
            } else {
                emptyStateMessage.style.display = 'none';
                const fragment = document.createDocumentFragment();
                groceryList.forEach(item => {
                    const itemNode = document.importNode(itemTemplate.content, true);
                    const itemDiv = itemNode.querySelector('.grocery-item');
                    itemDiv.dataset.id = item.id;

                    itemNode.querySelector('.name').textContent = item.name;
                    itemNode.querySelector('.price').textContent = `${formatCurrency(item.price)} each`;
                    itemNode.querySelector('.quantity').textContent = parseFloat(item.quantity).toFixed(2);
                    itemNode.querySelector('.item-subtotal').textContent = formatCurrency(item.price * item.quantity);

                    fragment.appendChild(itemNode);
                });
                groceryItemsView.appendChild(fragment); // Append all items efficiently
            }
            calculateTotal();
            saveState();
        };

        const renderHistory = () => {
            historyListEl.innerHTML = ''; // Clear existing history items
            if (shoppingHistory.length === 0) {
                emptyHistoryMessage.style.display = 'block';
            } else {
                emptyHistoryMessage.style.display = 'none';
                const sortedHistory = [...shoppingHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
                const fragment = document.createDocumentFragment();
                sortedHistory.forEach(record => {
                    const historyNode = document.importNode(historyItemTemplate.content, true);
                    const date = new Date(record.date).toLocaleDateString();
                    historyNode.querySelector('.history-date').textContent = date;
                    
                    const itemsBought = record.items.map(item => `${item.name} (${parseFloat(item.quantity).toFixed(2)})`).join(', ');
                    historyNode.querySelector('.history-items-list').textContent = `Items: ${itemsBought}`;

                    historyNode.querySelector('.history-total').textContent = formatCurrency(record.total);
                    fragment.appendChild(historyNode);
                });
                historyListEl.appendChild(fragment);
            }
            saveState();
        };

        const showModal = () => {
            itemNameInput.value = '';
            itemPriceInput.value = '';
            modal.style.display = 'flex';
            itemNameInput.focus();
        };

        const hideModal = () => {
            modal.style.display = 'none';
        };

        const addItem = () => {
            const name = itemNameInput.value.trim();
            const price = parseFloat(itemPriceInput.value);

            if (name && !isNaN(price) && price > 0) {
                groceryList.push({
                    id: `id_${Date.now()}`,
                    name: name,
                    price: price,
                    quantity: 1.00 
                });
                render(); // Re-render grocery list after adding
                hideModal();
            } else {
                alert('Please enter a valid item name and price (must be a positive number).');
            }
        };

        const handleListClick = (event) => {
            const target = event.target;
            // Ensure we are interacting with a grocery item within the groceryItemsView
            const itemDiv = target.closest('.grocery-item');
            if (!itemDiv || !groceryItemsView.contains(itemDiv)) return; // Added check for parent

            const itemId = itemDiv.dataset.id;
            const item = groceryList.find(i => i.id === itemId);
            if (!item) return;

            const quantityStep = 0.5; 

            if (target.matches('.increase-qty')) {
                item.quantity += quantityStep;
            } else if (target.matches('.decrease-qty')) {
                if (item.quantity > quantityStep) { 
                    item.quantity -= quantityStep;
                } else if (item.quantity > 0 && item.quantity <= quantityStep) {
                    if (confirm(`Are you sure you want to remove all ${item.name}?`)) {
                        groceryList = groceryList.filter(i => i.id !== itemId);
                    }
                }
            } else if (target.matches('.delete-button')) {
                if (confirm(`Are you sure you want to delete ${item.name}?`)) {
                    groceryList = groceryList.filter(i => i.id !== itemId);
                }
            }
            render(); // Re-render grocery list after quantity change or delete
        };

        const checkout = () => {
            if (groceryList.length === 0) {
                alert('Your cart is empty. Add items before checking out!');
                return;
            }

            const totalBill = groceryList.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            shoppingHistory.push({
                date: new Date().toISOString(),
                items: [...groceryList],
                total: totalBill,
                currency: currentCurrency
            });

            groceryList = []; 
            alert(`Checkout successful! Total: ${formatCurrency(totalBill)}`);
            
            // After checkout, always revert to the main cart view and update content
            toggleHistoryView(false); // Force switch to cart view
        };

        /**
         * Manages the visibility of the grocery list view and history view,
         * along with associated UI controls (FAB, Checkout, Total Card).
         * @param {boolean|null} showHistory - True to show history, False to show cart. Null to toggle.
         */
        const toggleHistoryView = (showHistory = null) => {
            const currentlyShowingHistory = historySection.style.display === 'block';
            const willShowHistory = (showHistory === true) || (showHistory === null && !currentlyShowingHistory);
            
            if (willShowHistory) {
                // Switching to History View
                historySection.style.display = 'block';
                groceryItemsView.style.display = 'none'; // Hide grocery list content
                addItemBtn.style.display = 'none'; // Hide FAB
                checkoutBtn.style.display = 'none'; // Hide Checkout button
                totalAmountEl.closest('.total-card').style.display = 'none'; // Hide Total Card
                viewHistoryBtn.textContent = 'Back to Cart';
                renderHistory(); // Ensure history content is up-to-date
            } else {
                // Switching to Cart View
                historySection.style.display = 'none';
                groceryItemsView.style.display = 'block'; // Show grocery list content
                addItemBtn.style.display = 'flex'; // Show FAB
                checkoutBtn.style.display = 'block'; // Show Checkout button
                totalAmountEl.closest('.total-card').style.display = 'flex'; // Show Total Card
                viewHistoryBtn.textContent = 'History';
                render(); // Ensure grocery list content is up-to-date
            }
        };

        const clearAllHistory = () => {
            if (confirm('Are you sure you want to clear all shopping history? This cannot be undone.')) {
                shoppingHistory = [];
                renderHistory();
            }
        };

        // --- Event Listeners ---
        addItemBtn.addEventListener('click', showModal);
        modalCancelBtn.addEventListener('click', hideModal);
        modalSaveBtn.addEventListener('click', addItem);
        // Event listener for list clicks should now be on groceryItemsView
        groceryItemsView.addEventListener('click', handleListClick); 
        currencySelector.addEventListener('change', (event) => {
            currentCurrency = event.target.value;
            // Only re-render the active view to update currency display
            if (groceryItemsView.style.display === 'block') {
                render(); 
            } else if (historySection.style.display === 'block') {
                renderHistory();
            }
        });
        checkoutBtn.addEventListener('click', checkout);
        // Pass 'null' to toggleHistoryView to allow it to auto-toggle
        viewHistoryBtn.addEventListener('click', () => toggleHistoryView(null)); 
        clearHistoryBtn.addEventListener('click', clearAllHistory);

        // Close modal if backdrop is clicked
        modal.addEventListener('click', (event) => {
            if(event.target === modal) {
                hideModal();
            }
        });

        // --- Initial Application Load ---
        loadState();
    });
</script>
